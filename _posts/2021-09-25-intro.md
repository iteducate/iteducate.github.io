---
layout: single
title:  "Структура протокола IP"
date:   2021-09-25 09:00:00 +0300
tags: ip
categories: protocols
comments: true

layouts_gallery_1:
  - url: /assets/images/ip/version.png
    image_path: /assets/images/ip/version.png

layouts_gallery_2:
  - url: /assets/images/ip/header_length.png
    image_path: /assets/images/ip/header_length.png

layouts_gallery_3:
  - url: /assets/images/ip/diffserve_ecn.png
    image_path: /assets/images/ip/diffserve_ecn.png

---

Формат заголовка протокола IP состоит из определённого набора полей, которые описаны в [RFC 791](https://www.rfc-editor.org/rfc/rfc791.html). Понимание данных полей важно для понимания процесса маршрутизации. Ниже я опишу данные поля и постараюсь показать их в реальности, используя Wireshark.

<figure>
  <img src="/assets/images/ip/structure_ip.png" alt="IP Header" style="width:100%">
  <figcaption align = "center"><b>Структура протокола IP</b></figcaption>
</figure>

**Version** - 4-битное поле, определяющее версию используемого протокола. В настоящее время используется две версии протокола - 4 (`0100`) версия и 6 (`0110`) версия.

{% include gallery id="layouts_gallery_1" caption="**Version**" %}

**Header Length** - 4-битное поле, которое показывает какова длина IP-заголовка _в 32-битных словах_. 

<p class="notice--info"><i class="fa fa-info-circle"></i><strong> Заметка:</strong> Минимальный размер IP-заголовка - 20 байт (<i>сумма всех полей заголовка при пустом поле Options</i>). Так как максимально в поле из 4 бит можно записать значение 15 (<code>1111</code>), то максимальный размер IP-заголовка составляет <code>15 * 4 байта = 60 байт</code></p>

{% include gallery id="layouts_gallery_2" caption="**Header Length**" %}

**Type of Service** - 8-битное поле, может быть использовано для определения обработки пакета. В настоящее время данное поле переопределено как часть фреймворка _Differentiated Services_. 

Данный фреймворк позволяет более гибко обрабатывать IP-пакеты. Фреймворк DiffServe определяет классы обслуживания (`service classes`) на маршрутизаторах, а затем уже производить сортировку согласно данным классам. Затем маршрутизатор может ставить в очередь и производить пересылку пакетов с различными уровнями приоритета в зависимости от их классификации. Каждая процедура постановки в очередь и пересылки называется PHB - [**Per-Hop Behaviour**](https://en.wikipedia.org/wiki/Per-hop_behaviour)

В современном мире 6 бит поля Type of Service определено как поле DSCP - *DiffServe Code Point*. Используя эти 6 бит, администратор может определить произвольно либо в соответствии с предопределенными в архитектуре DiffServe классами обслуживания до 64 классов обслуживания, которые затем могут быть отсортированы в PHB. 

Оставшиеся 2 бита используется для поля ECN - **Explicit Congestion Notification** - явное уведомление о перегрузках. Если маршрутизатор поддерживает данный параметр, то поле примет значение `11` в случае сигнализации о перегрузке.

{% include gallery id="layouts_gallery_3" caption="**DiffServe and ECN**" %}