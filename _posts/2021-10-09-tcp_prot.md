---
layout: single
title:  "Структура протокола TCP"
date:   2021-10-09 09:00:00 +0300
tags: protocols tcp 
categories: networks
comments: true

layouts_gallery_1:
  - url: /assets/images/tcp/structure_tcp.png
    image_path: /assets/images/tcp/structure_tcp.png

layouts_gallery_2:
  - url: /assets/images/tcp/src_dst_ports.png
    image_path: /assets/images/tcp/src_dst_ports.png

layouts_gallery_3:
  - url: /assets/images/tcp/tcp_seq_1.png
    image_path: /assets/images/tcp/tcp_seq_1.png

layouts_gallery_4:
  - url: /assets/images/tcp/tcp_seq_2.png
    image_path: /assets/images/tcp/tcp_seq_2.png
---

Transmission Control Protocol или TCP описан в [RFC 793](https://www.rfc-editor.org/rfc/rfc793.html), обеспечивает приложениям надежную службу, ориентированную на подключение. 

Протокол TCP *похож* на телефонный звонок, в котором сначала устанавливается соединение, затем передаются данные, и в конце осуществляется отключение когда передача данных завершена.

TCP использует три основных механизма, описанных ниже:

* Пакеты маркируются порядковыми номерами (`sequence number`). Это позволяет службе TCP с приёмной стороны восстановить корректную последовательность пакетов, прежде чем отправлять их конечному приложению.
* Для обеспечения надежности TCP использует механизмы подтверждения, чексуммы и таймеров (`acknowledment`, `checksum`, `timers`). Получатель может уведомить отправителя о том, что какой-то пакет из последовательности не пришел или содержит ошибки, или отправитель может предположить, что пакет не дошел до получателя, если получатель не прислал подтверждение получателю через определенное время.
* TCP использует механизм "плавающего окна" (`windowing`) для регулирования потока пакетов. Windowing уменьшает шанс того, что пакет будет отброшен приемной стороной из-за переполнения буфера.

Заголовок TCP следует сразу за данными прикладного уровня, он содержит поля необходимые для работы механизмов, которые описаны выше, а также определяет порты, которые в свою очередь определяют приложения источника и назначения. Данные с заголовком TCP затем инкапсулируются в заголовок IP.

Структура протокола TCP выглядит следующим образом

{% include gallery id="layouts_gallery_1" caption="**TCP Header Structure**" %}

**Source** и **Destination** порты - 16-битные поля, определяющие приложения источника и назначения для инкапсулированных данных. RFC 1700 определяет все номера для портов (*общего и не общего назначения*). 

<p class="notice--info"><i class="fa fa-info-circle"></i><strong><code>Сокет</code></strong> - сочетание порта (<i>источника/назначения</i>) и соответствующего IP-адреса. Сокет уникально определяет каждое приложение в сети.</p> 

{% include gallery id="layouts_gallery_2" caption="**Source and Destination Ports**" %}

**Sequence Number** - 32-битное поле, определяет где инкапсулированные данные находятся внутри общего потока отправителя. Например, если порядковый номер сегмента 1234 и сегмент содержит 512 байт данных, то следующий сегмент должен иметь порядковый номер `1234 + 512 = 1746` 

Ниже представлена вырезка из трафика, в котором sequence number равен `337`, ожидаемый следующий порядковый номер должен быть `390`, который состоить из `seq number` + `TCP Payload` (*337 + 53 = 390*)

{% include gallery id="layouts_gallery_3" caption="**Sequence Number 1**" %}

А вот вторая вырезка, которая подтверждает ожидаемый в предыдущем пакете порядковый номер.

{% include gallery id="layouts_gallery_4" caption="**Sequence Number 2**" %}

**P.S.** *вся информация представленная здесь используется исключительно в образовательных целях. Все совпадения с реальными объектами, адресами, именами и т.д. случайна и не несёт цели получить от этого выгоду или причинить кому-либо вред.*